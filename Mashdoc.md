# MASH: Model Abstraction from SBML to HillTau

MASH is a utility to help perform model abstraction from chemical kinetic 
level models, typicaly encoded in SBML, to the more abstract and sparse 
HillTau forms. 
Specifically, MASH helps to set the parameters of the HillTau model so that it
behaves like the SBML model. It does so by
delivering a set of stimuli to the SBML model, and then running an 
optimization routine to tweak the parameters of the HillTau model till it fits.

### Test run examples
To give  you a flavour of what MASH can do, here are a couple of expmples.

1. Deliver a step stimulus from t=10 s to t=20s, run it on till 30s:

	```python mash.py fb_inhib.xml fb_inhib.json --stimulus input 1e-3 10 0 20 0 30 --plot```<br>
![alt text](Images/mash_fitting1.png?raw=true "Fitting HT using step function stimulus")

Here we ask Mash to give a stimulus of 1e-3 mM to molecule *input* starting
at time 10, then set it to 0 at time 20, and 0 again at time 30 to continue the
run for 10 seconds more at the basal level.
This fitting routine runs within a second of wallclock time, and Mash prints 
out a list of parameters and how much they were scaled to achieve the nice fit. It also reports a few diagnostics, the most important of which is:

	Initial score = 0.0669006, Final score = 0.0049291

These are *RMS/mean* scores for difference between the SBML model and HillTau, 
Low numbers are better. This says that the orignal model had a mean 6.7%
difference, and the final one had less than 0.5% difference.

The *--plot* argument tells Mash to plot the reference mass-action output 
as well as the time-series responses of the HillTau model output for the 
initial HillTau model, and the optimized one.
Here the orange line is the original HillTau fit. The green line is the fit
after the optimization, and it fits so well you can't see the blue line, which
is the original mass-action model. Although this looks good, it is
quite limited. The stimulus space is hardly explored. In the next example we
will push Mash a little harder.

2. Deliver a standard fitting protocol: dose-response followed by fast and slow
time-series. Save the resulting model as *optfile.json*.

	```python mash.py fb_inhib.xml fb_inhib.json --builtin input 1e-4 10 --plot --optfile optfile.json```<br>
![alt text](Images/mash_fitting2.png?raw=true "Fitting HT using step function stimulus")

This is a production simulation. The builtin stimulus probes many aspects of
the HillTau model behaviour, and if it fits well it will probably do a good
job on almost any other stimulus. In this case the *--optfile ex1.json*
argument tells mash to save its output in the file *ex1.json*.
This takes a little longer to run, about 3 seconds, and again we get a set of
parameters and the same set of diagnostics. This time it had to work harder to
get a decent fit to wider range of stimuli:

	Initial score = 0.174809, Final score = 0.0309704

Here the end score of RMS/mean is about 3%.

In the examples above, the mash function is run using a pre-existing JSON
model *fb_inhib.json* and its mass action (.xml) counterpart.

### Using MASH.

MASH is a utility to do Model Abstraction from SBML to HillTau

Essentially, it takes an SBML model and fits a HillTau model to it.

At this point the HillTau model has to be generated by hand. 
The user picks which input molecules to model, which output molecules to model,
and any essential intermediates. Then the user connects them up as one would
a pathway block diagram. This gives the starting HillTau model.
[See the documentation for HillTau for details](Documentation.md)

The user specifies stimuli that the model should replicate. These
can include time-series, dose-response curves, and cyclic stimuli.

Optionally, the user can specify which subset of parameters should be optimized.

**Example: Adding parameters**:
	
	python mash.py fb_inhib.xml fb_inhib.json --builtin input 1e-4 10 --addParams output.tau output.KA fb.tau fb.KA --plot

This example removes the default set of parameters and explicitly adds the *tau* and *KA* terms on each of the *output* and *fb* reactions. The optimization then takes place for just these 4 parameters.


**Example: Removing parameters**

	python mash.py fb_inhib.xml fb_inhib.json --builtin input 1e-4 10 --removeParams output.tau fb.tau --plot

This example starts with the default set of parameters (all of them) and 
removes just two, the *output.tau* and the *fb.tau*. The optimization will now
only use the remaining ones.


### MASH command line options:

**Help:**

	> python mash.py -h
	> python mash.py --help


	usage: mash.py [-h] [-m molName [molName ...]] [-b molecule midconc midtime]
               [-c molecule conc onTime offTime num_cycles]
               [-d molecule midconc settle_time]
               [-a obj.field [obj.field ...]] [-r param [param ...]]
               [-s args [args ...]] [-p] [-t TOLERANCE] [-o OPTFILE]
               chemModel HillTauModel

	Optimizes HillTau models to fit chemical kinetic (mass action and Michaelis-
	Menten) models of chemical signalling.

	positional arguments:
	  chemModel             Required: Filepath for chemical kinetic model
	  HillTauModel          Required: Filepath for HillTau model
	
	optional arguments:
	  -h, --help            show this help message and exit
	  -m molName [molName ...], --monitor molName [molName ...]
	                        Optional: Molecules to monitor, as a list of space-
	                        separated names. If names differ between chemical and
	                        HillTau models, both can be specified, separated by a
	                        colon. Example: Ca:Calcium.
	  -b molecule midconc midtime, --builtin molecule midconc midtime
	                        Optional: Deliver builtin stimulus. This is a dose-
	                        response centered around midconc, with a settling time
	                        of midtime * 10. This is followed by a timeseries of
	                        square-wave pulses from 0 to midconc, with on-time of
	                        midtime/10 followed by another with on-time of
	                        midtime. The first runs for 170 cycles and the second
	                        for 17. If multiple builtin stimuli are specified,
	                        they will be executed in order, without overlap. If
	                        molecule names are different between chem and HillTau
	                        models, they should be separated by a colon.
	  -c molecule conc onTime offTime num_cycles, --cyclic molecule conc onTime offTime num_cycles
	                        Optional: Deliver cyclic stimulus. This is a
	                        timeseries of rectangular pulses from 0 to conc, with
	                        an onTime and offTime as specified, repeated for
	                        num_cycles. Before the first cycle, and after the last
	                        cycle it runs for another "offTime" seconds at conc =
	                        0. If molecule names are different between chem and
	                        HillTau models, they should be separated by a colon.
	  -d molecule midconc settle_time, --dose_response molecule midconc settle_time
	                        Optional: Deliver dose-response stimulus centered
	                        around midconc, with a settling time of settle_time.
	                        If other builtin, cyclic or dose_response stimuli are
	                        specified, they will be executed in order, without
	                        overlap. If molecule names are different between chem
	                        and HillTau models, they should be separated by a
	                        colon.
	  -a obj.field [obj.field ...], --addParams obj.field [obj.field ...]
	                        Optional: Add parameter list. This will remove all the
	                        automatic ones obtained by scanning through the model,
	                        and only use the added ones from this list. Each
	                        parameter is of the form object.field. Any number of
	                        parameters can be added, separated by spaces. If
	                        molecule names are different between chem and HillTau
	                        models, they should be separated by a colon
	  -r param [param ...], --removeParams param [param ...]
	                        Optional: Remove parameters from the default ones
	                        which were generated automatically by scanning all the
	                        reactions in the model. Each parameter is of the form
	                        object.field. Any number of parameters can be added,
	                        separated by spaces.
	  -s args [args ...], --stimulus args [args ...]
	                        Optional: Deliver stimulus as follows: --stimulus
	                        molecule conc time [conc time]... Each stimulus
	                        molecule may be followed by one or more [conc time]
	                        pairs. Any number of stimuli may be given, each
	                        indicated by --stimulus. Stimuli can overlap with the
	                        builtin stimuli, the values will apply from the time
	                        they are given till the builtin protocol delivers its
	                        own stimulus to override them.
	  -p, --plot            Flag: when set, it plots the chem output, the original
	                        HillTau output, and the optimized HillTau output
	  -t TOLERANCE, --tolerance TOLERANCE
	                        Optional: tolerance for convergence of optimization.
	  -o OPTFILE, --optfile OPTFILE
	                        Optional: File name for saving optimized HillTau
	                        model. If not set, no file is saved.
	
	


### MASH Input model formats:

chemModel types:<br>
Kinetikit (.g) or SBML (.xml) files for the chemical kinetic ODE model

HillTauModel types:<br>
HillTau (.json) file for the HillTau abstract model.

Output model formats: <br>
HillTau (.json) file.



### Examples:

1.	Do a dose-response curve fit for stimulus molecule _input_ and output 
molecule _output_. Set the middle concentration to 1 uM and the 
settling time to 100s:

		python mash.py SBML_MODELS/fb_inhib.xml HT_MODELS/fb_inhib_old.json -d input 1e-3 100 -p -t 1e-9
	
		File: SBML_MODELS/fb_inhib.xml (Level 3, version 1)
		Completed reference run of 'SBML_MODELS/fb_inhib.xml' in 0.05s
		..................................................................................................................................
		Object.field           Scale factor
		output.KA             0.195105
		output.tau            1.722921
		output.gain           4.739541
		fb.KA                 0.197340
		fb.tau                100.000000
		Timings: reference= 0.05s, optimization= 1.00s, HillTau Cumulative = 0.10s 
		Number of evaluations = 962, number of optimization iterations = 130, 
		Initial score = 0.269966, Final score = 0.0368697
	
	
This run ends with a decent fit of under 4% normalized RMS difference from 
target.
![alt text](Images/Mash_dose_resp_ex.png?raw=true "Mash dose_response example")


2.	Do a time-series curve fit for stimulus molecule _input_ and output 
molecule _output_. Give a series of 1 uM pulses with on-time of 20 s and off 
time of 50s, and repeat this 5 times:

		python mash.py SBML_MODELS/fb_inhib.xml HT_MODELS/fb_inhib_old.json -c input 1e-3 20 50 5 -m output -p
		
		File: SBML_MODELS/fb_inhib.xml (Level 3, version 1)
		Completed reference run of 'SBML_MODELS/fb_inhib.xml' in 0.03s
		..............
		Object.field           Scale factor
		output.KA             1.418895
		output.tau            1.198456
		output.gain           2.767984
		fb.KA                 1.418895
		fb.tau                1.302370
		Timings: reference= 0.03s, optimization= 0.10s, HillTau Cumulative = 0.01s 
		Number of evaluations = 140, number of optimization iterations = 14, 
		Initial score = 0.131639, Final score = 0.00568797


This run gives an excellent fit of under 1% normalised RMS difference from 
target. 

![alt text](Images/Mash_cyclic_ex.png?raw=true "Mash cyclic stimulus example")


3. Give a single pulse stimulus of 1 uM on molecule _input_ starting at time 
	100s and going till time 250s, and keep the run going till 400s.

		python mash.py SBML_MODELS/fb_inhib.xml HT_MODELS/fb_inhib_old.json --stimulus input 1e-3 100 0 250 0 400 --monitor output --plot


